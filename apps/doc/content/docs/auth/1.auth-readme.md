---
title: Authentication Sync Between Web App and Browser Extension
description: details about kiro's auth steps
---

# Authentication Sync Between Web App and Browser Extension

## What This Does

This system makes sure that when you log in on your website, you're automatically logged in on your browser extension too. And when you log out from either place, you're logged out everywhere.

Think of it like this: Your website and browser extension are like two doors to the same house. When you unlock one door, the other door automatically unlocks too.

## How It Works (Simple Explanation)

1. **You log in on website** → Website tells extension "Hey, user is logged in!"
2. **Extension gets the message** → Extension updates to show you're logged in
3. **Same thing works backwards** → Log in on extension, website knows about it
4. **Everything stays in sync** → Both always show the same login status

## What I Built For You

### 1. Extension Side (Browser Extension)

#### Auth Client (`apps/extension/src/lib/auth-client.ts`)

```typescript
// This connects your extension to your server
export const authClient = createAuthClient({
  baseURL: "http://localhost:3000", // Your server
  fetchOptions: {
    credentials: "include", // Include cookies for auth
  },
});
```

**What it does:** Lets your extension talk to your server for login/logout.

#### Storage System (`apps/extension/src/lib/auth-storage.ts`)

```typescript
// Save login info in browser storage
static async saveAuthState(authState) {
  await chrome.storage.local.set({
    'promptsu_auth_state': authState
  });
}

// Get login info from browser storage
static async getAuthState() {
  const result = await chrome.storage.local.get('promptsu_auth_state');
  return result['promptsu_auth_state'];
}
```

**What it does:** Remembers if you're logged in, even after closing browser.

#### Sync Manager (`apps/extension/src/lib/auth-sync.ts`)

```typescript
// Check with server every 5 minutes
static async initialize() {
  await this.syncAuthState();

  // Auto-sync every 5 minutes
  setInterval(() => {
    this.syncAuthState();
  }, 5 * 60 * 1000);
}
```

**What it does:** Keeps checking with server to make sure login status is correct.

#### Background Script (`apps/extension/src/app/background.ts`)

```typescript
// Listen for messages from other parts of extension
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === "SYNC_AUTH") {
    AuthSync.syncAuthState().then((authState) => {
      sendResponse({ success: true, authState });
    });
  }
});
```

**What it does:** Runs in background, handles sync between different parts.

#### Content Script (`apps/extension/src/app/content/auth-sync.tsx`)

```typescript
// Watch for login/logout on website
window.addEventListener("promptsu-auth-sync", (event) => {
  const { type, data } = event.detail;

  if (type === "USER_SIGNED_IN") {
    // Tell extension user logged in
    chrome.runtime.sendMessage({ type: "SYNC_AUTH" });
  }
});
```

**What it does:** Watches your website and tells extension when you log in/out.

### 2. Website Side (Web App)

#### Extension Sync (`apps/web/src/lib/extension-sync.ts`)

```typescript
// Tell extension about login
static notifyUserSignedIn(userData) {
  const event = new CustomEvent('promptsu-auth-sync', {
    detail: {
      type: 'USER_SIGNED_IN',
      data: userData,
    },
  });
  window.dispatchEvent(event);
}
```

**What it does:** Sends messages to extension when you log in/out on website.

#### Enhanced Auth Hook (`apps/web/src/hooks/use-auth-with-extension-sync.ts`)

```typescript
// Normal login + tell extension
const signIn = async (email, password) => {
  const result = await authClient.signIn.email({ email, password });

  if (result.data?.user) {
    // Tell extension about successful login
    ExtensionSync.notifyUserSignedIn({
      user: result.data.user,
      session: sessionData.data?.session || null,
    });
  }

  return result;
};
```

**What it does:** Does normal login but also tells extension about it.

### 3. Server Side (Backend)

#### Updated CORS Settings (`apps/server/src/lib/auth.ts`)

```typescript
// Allow extension to connect to server
trustedOrigins: [
  'http://localhost:3001',    // Your website
  'chrome-extension://*',     // Chrome extensions
  'moz-extension://*',        // Firefox extensions
],
```

**What it does:** Lets extension make requests to your server safely.

## Step-by-Step: What Happens When You Log In

### Scenario 1: Login on Website

1. You enter email/password on website
2. Website sends login request to server
3. Server says "OK, you're logged in"
4. Website saves your login info
5. Website sends message: "User logged in!"
6. Extension content script hears the message
7. Extension background script syncs with server
8. Extension popup shows you're logged in

### Scenario 2: Login on Extension

1. You enter email/password in extension popup
2. Extension sends login request to server
3. Server says "OK, you're logged in"
4. Extension saves login info in browser storage
5. Extension updates popup to show logged in
6. When you visit website, it checks server and sees you're logged in

## Files I Created/Modified

### Extension Files (New)

- `src/lib/auth-client.ts` - Connects to server
- `src/lib/auth-storage.ts` - Saves login info
- `src/lib/auth-sync.ts` - Manages syncing
- `src/lib/web-sync.ts` - Listens to website
- `src/hooks/use-auth.ts` - React hook for auth
- `src/components/auth/auth-form.tsx` - Login form
- `src/components/auth/user-profile.tsx` - User info display
- `src/components/auth/sync-status.tsx` - Shows sync status
- `src/app/background.ts` - Background worker (updated)
- `src/app/content/auth-sync.tsx` - Website watcher
- `wxt.config.ts` - Added permissions (updated)

### Website Files (New)

- `src/lib/extension-sync.ts` - Talks to extension
- `src/hooks/use-auth-with-extension-sync.ts` - Enhanced auth hook
- `src/app/root-providers.tsx` - Initialize sync (updated)

### Server Files (Updated)

- `src/lib/auth.ts` - Allow extension requests

## Configuration Details

### Extension Permissions (`wxt.config.ts`)

```typescript
manifest: {
  permissions: [
    "storage",      // Save login info
    "activeTab",    // Access current tab
    "scripting",    // Run scripts on pages
  ],
  host_permissions: [
    "http://localhost:3000/*", // Your server
    "http://localhost:3001/*", // Your website
  ],
}
```

### Server CORS (`apps/server/src/lib/auth.ts`)

```typescript
trustedOrigins: [
  'http://localhost:3001',
  'chrome-extension://*',
  'moz-extension://*',
  '*', // Remove this in production!
],
```

## How to Test It

1. **Start everything:**

   ```bash
   bun dev  # Starts server + website
   ```

2. **Build extension:**

   ```bash
   cd apps/extension
   bun run build
   ```

3. **Load extension in Chrome:**

   - Go to `chrome://extensions/`
   - Turn on "Developer mode"
   - Click "Load unpacked"
   - Select `apps/extension/dist/chrome-mv3` folder

4. **Test sync:**
   - Open website at `http://localhost:3001`
   - Open extension popup
   - Log in on website → Extension should show logged in
   - Log out from extension → Website should show logged out

## Other Ways to Do This (Alternatives)

### 1. **WebSocket Real-Time Sync**

```typescript
// Instead of checking every 5 minutes, use real-time updates
const ws = new WebSocket("ws://localhost:3000/auth-sync");
ws.onmessage = (event) => {
  const { type, user } = JSON.parse(event.data);
  if (type === "USER_LOGGED_IN") {
    updateExtensionUI(user);
  }
};
```

**Pros:** Instant updates, no delays
**Cons:** More complex, uses more resources

### 2. **Shared Cookie Approach**

```typescript
// Use same cookies for website and extension
document.cookie = "auth_token=abc123; domain=.yourdomain.com";
```

**Pros:** Simple, browser handles sync
**Cons:** Only works if extension and website on same domain

### 3. **Local Storage Polling**

```typescript
// Extension checks website's localStorage every few seconds
setInterval(() => {
  const authToken = localStorage.getItem("auth_token");
  if (authToken !== lastKnownToken) {
    syncAuthState();
  }
}, 2000);
```

**Pros:** Simple to implement
**Cons:** Only works when website is open, uses more CPU

### 4. **Server-Side Sessions with Polling**

```typescript
// Extension asks server "Am I logged in?" every minute
setInterval(async () => {
  const response = await fetch("/api/auth/check");
  const { isLoggedIn } = await response.json();
  updateExtensionState(isLoggedIn);
}, 60000);
```

**Pros:** Always accurate, simple
**Cons:** More server requests, slower updates

### 5. **Browser Native Messaging**

```typescript
// Use Chrome's native messaging API
chrome.runtime.sendNativeMessage(
  "com.yourapp.auth",
  { action: "checkAuth" },
  (response) => {
    updateAuthState(response.isLoggedIn);
  }
);
```

**Pros:** Very secure, fast
**Cons:** Requires native app installation, complex setup

### 6. **Database Change Listeners**

```typescript
// Listen to database changes directly
db.auth_sessions.watch().on("change", (change) => {
  if (change.operationType === "insert") {
    notifyAllClients("USER_LOGGED_IN", change.fullDocument);
  }
});
```

**Pros:** Real-time, accurate
**Cons:** Requires database that supports change streams

## Why I Chose This Approach

1. **Works Offline:** Extension remembers login state
2. **Real-Time Feel:** Content script gives instant updates
3. **Reliable:** Background sync ensures consistency
4. **Secure:** Uses proper authentication tokens
5. **Simple:** No extra infrastructure needed
6. **Cross-Browser:** Works in Chrome, Firefox, etc.

## Production Considerations

### Security Updates Needed:

```typescript
// Remove wildcard origins
trustedOrigins: [
  'https://yourdomain.com',
  'chrome-extension://your-actual-extension-id',
],

// Enable secure cookies
defaultCookieAttributes: {
  sameSite: 'none',
  secure: true,  // HTTPS only
  httpOnly: true,
}
```

### Performance Optimizations:

- Increase sync interval to 10-15 minutes
- Add exponential backoff for failed requests
- Cache auth state to reduce server calls
- Use compression for large user data

## Troubleshooting Common Issues

### Extension Not Syncing

```bash
# Check extension console
Right-click extension → Inspect → Console

# Check permissions
chrome://extensions → Your Extension → Details
```

### CORS Errors

```typescript
// Make sure server allows extension
trustedOrigins: ["chrome-extension://your-extension-id"];
```

### Auth State Not Persisting

```typescript
// Check Chrome storage
Extension DevTools → Application → Storage → Local Storage
```

This system gives you a solid foundation for keeping authentication in sync between your website and browser extension. It's reliable, secure, and user-friendly!
